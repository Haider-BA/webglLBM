
<!DOCTYPE html>
<html lang="en">
	<head>
		<title>three.js webgl - render-to-texture</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>
			body {
				color: #ffffff;
				font-family:Monospace;
				font-size:13px;
				text-align:center;
				font-weight: bold;
				background-color: #000000;
				margin: 0px;
				overflow: hidden;
			}

			#info {
				position: absolute;
				top: 300px; width: 100%;
				padding: 5px;
			}

			a {
				color: #ffffff;
			}

		</style>
	</head>
	<body>
		<div id="container"></div>
		<div id="info"><a href="https://github.com/yhenon/webglLBM" target="_blank">webglLBM</a> LBM implemented in webGL with ThreeJS</div>

		<script src="./js/three.min.js"></script>

		<script src="./js/Detector.js"></script>
		<script src="./js/stats.min.js"></script>

		<script id="fragmentCompute1" type="x-shader/x-fragment">
			precision highp float;
			precision highp int;

			varying vec2 vUv;
			uniform highp sampler2D tDiffuse1;
			uniform highp sampler2D tDiffuse2;
			uniform highp sampler2D tDiffuse3;
			uniform highp float currTime;

			void main() {
				float omega=0.25; 
				//float density=1.0; 
				float t1=4./9.; 
				float t2=1./9.; 
				float t3=1./36.; 
				float c_squ=1./3.;

				vec4 v1 = texture2D( tDiffuse1, vUv);
				vec4 v2 = texture2D( tDiffuse2, vUv);
				vec4 v3 = texture2D( tDiffuse3, vUv);

				float f1 = v1.r;
				float f2 = v1.g;
				float f3 = v1.b;
				 
				float f4 = v2.r;
				float f5 = v2.g;
				float f6 = v2.b;
				 
				float f7 = v3.r;
				float f8 = v3.g;
				float f9 = v3.b;
				
				float density = f1+f2+f3+f4+f5+f6+f7+f8+f9;
				float invDensity = 1./ density;
				float ux = invDensity *(f1+f2+f8-f4-f5-f6);
				float uy = invDensity *(f2+f3+f4-f6-f7-f8);
				if (currTime < 0.1 && (vUv.x < 0.002 )) {
					ux += .02;
				};
				float usqu = ux*ux + uy*uy;
				float uc2 = ux+uy;
				float uc4 = -ux+uy;
				float uc6 = -uc2;
				float uc8 = -uc4;
 
				float feq1 = t2*density*(1. + ux/c_squ+0.5*(ux/c_squ)*(ux/c_squ)- usqu/(2.*c_squ));
				float feq3 = t2*density*(1. + uy/c_squ+0.5*(uy/c_squ)*(uy/c_squ) - usqu/(2.*c_squ));
				float feq5 = t2*density*(1. - ux/c_squ+0.5*(ux/c_squ)*(ux/c_squ)- usqu/(2.*c_squ));
				float feq7 = t2*density*(1. - uy/c_squ+0.5*(uy/c_squ)*(uy/c_squ) - usqu/(2.*c_squ));
 
				float feq2 = t3*density*(1. + uc2/c_squ+0.5*(uc2/c_squ)*(uc2/c_squ)- usqu/(2.*c_squ));
				float feq4 = t3*density*(1. + uc4/c_squ+0.5*(uc4/c_squ)*(uc4/c_squ)- usqu/(2.*c_squ));
				float feq6 = t3*density*(1. + uc6/c_squ+0.5*(uc6/c_squ)*(uc6/c_squ)- usqu/(2.*c_squ));
				float feq8 = t3*density*(1. + uc8/c_squ+0.5*(uc8/c_squ)*(uc8/c_squ)- usqu/(2.*c_squ));
 
				float feq9 = t1*density*(1. - usqu/(2.*c_squ));

				if ( vUv.x < 0.6 && vUv.x > 0.5 && vUv.y > 0.5 && vUv.y < 0.6 ) {
					
					gl_FragColor = vec4(f1, f2, f3, 1.);
				} 	else {

				float ff1 = omega * feq1 + (1. - omega) * f1;
				float ff2 = omega * feq2 + (1. - omega) * f2;
				float ff3 = omega * feq3 + (1. - omega) * f3;

				gl_FragColor = vec4(ff1,ff2,ff3,1.);
				}


			}

		</script>
		<script id="fragmentCompute2" type="x-shader/x-fragment">
			precision highp float;
			precision highp int;

			varying vec2 vUv;
			uniform highp sampler2D tDiffuse1;
			uniform highp sampler2D tDiffuse2;
			uniform highp sampler2D tDiffuse3;
			uniform highp float currTime;


			void main() {
				float omega=0.25; 
				//float density=1.0; 
				float t1=4./9.; 
				float t2=1./9.; 
				float t3=1./36.; 
				float c_squ=1./3.;

				vec4 v1 = texture2D( tDiffuse1, vUv);
				vec4 v2 = texture2D( tDiffuse2, vUv);
				vec4 v3 = texture2D( tDiffuse3, vUv);
				float f1 = v1.r;
				float f2 = v1.g;
				float f3 = v1.b;
				 
				float f4 = v2.r;
				float f5 = v2.g;
				float f6 = v2.b;
				 
				float f7 = v3.r;
				float f8 = v3.g;
				float f9 = v3.b;
				
				float density = f1+f2+f3+f4+f5+f6+f7+f8+f9;
				float invDensity = 1./ density;
				float ux = invDensity *(f1+f2+f8-f4-f5-f6);
				float uy = invDensity *(f2+f3+f4-f6-f7-f8);				
				if (currTime < 0.1 && (vUv.x < 0.002 )) {
					ux += .02;
				};
				float usqu = ux*ux + uy*uy;
				float uc2 = ux+uy;
				float uc4 = -ux+uy;
				float uc6 = -uc2;
				float uc8 = -uc4;

				float feq1 = t2*density*(1. + ux/c_squ+0.5*(ux/c_squ)*(ux/c_squ)- usqu/(2.*c_squ));
				float feq3 = t2*density*(1. + uy/c_squ+0.5*(uy/c_squ)*(uy/c_squ) - usqu/(2.*c_squ));
				float feq5 = t2*density*(1. - ux/c_squ+0.5*(ux/c_squ)*(ux/c_squ)- usqu/(2.*c_squ));
				float feq7 = t2*density*(1. - uy/c_squ+0.5*(uy/c_squ)*(uy/c_squ) - usqu/(2.*c_squ));

				float feq2 = t3*density*(1. + uc2/c_squ+0.5*(uc2/c_squ)*(uc2/c_squ)- usqu/(2.*c_squ));
				float feq4 = t3*density*(1. + uc4/c_squ+0.5*(uc4/c_squ)*(uc4/c_squ)- usqu/(2.*c_squ));
				float feq6 = t3*density*(1. + uc6/c_squ+0.5*(uc6/c_squ)*(uc6/c_squ)- usqu/(2.*c_squ));
				float feq8 = t3*density*(1. + uc8/c_squ+0.5*(uc8/c_squ)*(uc8/c_squ)- usqu/(2.*c_squ));

				float feq9 = t1*density*(1. - usqu/(2.*c_squ));
				
				float ff4 = omega * feq4 + (1. - omega) * f4;
				float ff5 = omega * feq5 + (1. - omega) * f5;
				float ff6 = omega * feq6 + (1. - omega) * f6;
				if ( vUv.x < 0.6 && vUv.x > 0.5 && vUv.y > 0.5 && vUv.y < 0.6 ) {
					
					gl_FragColor = vec4(f4, f5, f6, 1.);
				} 	else {

				gl_FragColor = vec4(ff4,ff5,ff6,1.);
			}
		}

		</script>
		<script id="fragmentCompute3" type="x-shader/x-fragment">
			precision highp float;
			precision highp int;

			varying vec2 vUv;
			uniform highp sampler2D tDiffuse1;
			uniform highp sampler2D tDiffuse2;
			uniform highp sampler2D tDiffuse3;
			uniform highp float currTime;


			void main() {
				float omega=0.25; 
				//float density=1.0; 
				float t1=4./9.; 
				float t2=1./9.; 
				float t3=1./36.; 
				float c_squ=1./3.;

				vec4 v1 = texture2D( tDiffuse1, vUv);
				vec4 v2 = texture2D( tDiffuse2, vUv);
				vec4 v3 = texture2D( tDiffuse3, vUv);
				float f1 = v1.r;
				float f2 = v1.g;
				float f3 = v1.b;
				 
				float f4 = v2.r;
				float f5 = v2.g;
				float f6 = v2.b;
				 
				float f7 = v3.r;
				float f8 = v3.g;
				float f9 = v3.b;
				
				float density = f1+f2+f3+f4+f5+f6+f7+f8+f9;
				float invDensity = 1./ density;
				float ux = invDensity *(f1+f2+f8-f4-f5-f6);
				float uy = invDensity *(f2+f3+f4-f6-f7-f8);
				if (currTime < 0.1 && (vUv.x < 0.002 )) {
					ux += .02;
				};
				float usqu = ux*ux + uy*uy;
				float uc2 = ux+uy;
				float uc4 = -ux+uy;
				float uc6 = -uc2;
				float uc8 = -uc4;

				float feq1 = t2*density*(1. + ux/c_squ+0.5*(ux/c_squ)*(ux/c_squ) - usqu/(2.*c_squ));
				float feq3 = t2*density*(1. + uy/c_squ+0.5*(uy/c_squ)*(uy/c_squ) - usqu/(2.*c_squ));
				float feq5 = t2*density*(1. - ux/c_squ+0.5*(ux/c_squ)*(ux/c_squ) - usqu/(2.*c_squ));
				float feq7 = t2*density*(1. - uy/c_squ+0.5*(uy/c_squ)*(uy/c_squ) - usqu/(2.*c_squ));
 
				float feq2 = t3*density*(1. + uc2/c_squ+0.5*(uc2/c_squ)*(uc2/c_squ) - usqu/(2.*c_squ));
				float feq4 = t3*density*(1. + uc4/c_squ+0.5*(uc4/c_squ)*(uc4/c_squ) - usqu/(2.*c_squ));
				float feq6 = t3*density*(1. + uc6/c_squ+0.5*(uc6/c_squ)*(uc6/c_squ) - usqu/(2.*c_squ));
				float feq8 = t3*density*(1. + uc8/c_squ+0.5*(uc8/c_squ)*(uc8/c_squ) - usqu/(2.*c_squ));
 
				float feq9 = t1*density*(1. - usqu/(2.*c_squ));

				float ff7 = omega * feq7 + (1. - omega) * f7;
				float ff8 = omega * feq8 + (1. - omega) * f8;
				float ff9 = omega * feq9 + (1. - omega) * f9;				
				if ( vUv.x < 0.6 && vUv.x > 0.5 && vUv.y > 0.5 && vUv.y < 0.6 ) {
					
					gl_FragColor = vec4(f7, f8, f9, 1.);
				} 	else {

				gl_FragColor = vec4(ff7,ff8,ff9,1.);
			}
			}

		</script>				
		<script id="fragmentCopy1" type="x-shader/x-fragment">
			precision highp float;
			precision highp int;

			varying vec2 vUv;
			uniform highp sampler2D tDiffuse1;

			void main() {
				gl_FragColor = texture2D( tDiffuse1, vUv );

			}

		</script>
		<script id="fragmentCopy2" type="x-shader/x-fragment">
			precision highp float;
			precision highp int;

			varying vec2 vUv;
			uniform highp sampler2D tDiffuse2;

			void main() {
				gl_FragColor = texture2D( tDiffuse2, vUv );

			}

		</script>
		<script id="fragmentCopy3" type="x-shader/x-fragment">
			precision highp float;
			precision highp int;

			varying vec2 vUv;
			uniform highp sampler2D tDiffuse3;

			void main() {
				gl_FragColor = texture2D( tDiffuse3, vUv );

			}

		</script>		
		<script id="fragmentShow" type="x-shader/x-fragment">
			precision highp float;
			precision highp int;

			varying vec2 vUv;
			uniform highp sampler2D tDiffuse1;
			uniform highp sampler2D tDiffuse2;
			uniform highp sampler2D tDiffuse3;

			void main() {
				vec4 v1 = texture2D( tDiffuse1, vUv );
				vec4 v2 = texture2D( tDiffuse2, vUv );
				vec4 v3 = texture2D( tDiffuse3, vUv );

				float f1 = v1.r;
				float f2 = v1.g;
				float f3 = v1.b;
				float f4 = v2.r;
				float f5 = v2.g;
				float f6 = v2.b;				 
				float f7 = v3.r;
				float f8 = v3.g;

				float ux = f1+f2+f8-f4-f5-f6;
				float uy = f2+f3+f4-f6-f7-f8;
				float velmag = 1000.*sqrt(0.*ux*ux+1.*uy*uy);// 10.*sqrt(1.*uy*uy+1.*ux*ux);
				float a=(1.-velmag)/0.25;	//invert and group
				int X= int(floor(a));	//this is the integer part
				int Y= int(floor(255.*(a-float(X)))); //fractional part from 0 to 255
				float r,g,b;
				if (X == 0) {
				    r=255.;
				    g=float(Y);
				    b=0.;
				} else if ( X == 1) {
					r=255.- float(Y);
					g=255.;
					b=0.;
				} else if ( X == 2) {
				    r=0.;
				    g=255.;
				    b=float(Y);
				} else if (X == 3) {
					r=0.;
					g=255.- float(Y);
					b=255.;
				} else if (X ==4 ) {
				    r=0.;
				    g=0.;
				    b=255.;
				} else {
				    r=0.;
				    g=0.;
				    b=0.;
				}
				//if (velmag > 1.) { velmag = 1; };
				gl_FragColor = vec4(r/255., g/255.,b/255., 1.);
				//gl_FragColor = vec4(velmag, 0., 1. - velmag, 1.);


			}

		</script>

		<script id="fragmentStep1" type="x-shader/x-fragment">
			precision highp float;
			precision highp int;

			varying vec2 vUv;
			uniform float time;
			uniform float dt;
			uniform highp sampler2D tDiffuse3;

			void main() {

				if (time  == 0. )  {
					gl_FragColor = vec4(1./9.,1./9.,1./9.,1.);
				} else {
					float h = - dt;
					//vec4 fVec = texture2D( tDiffuse3, vUv + vec2(h,0.));
					float f1 = texture2D( tDiffuse3, vUv + vec2(h,0)).r;
					float f2 = texture2D( tDiffuse3, vUv + vec2(h,h)).g;
					float f3 = texture2D( tDiffuse3, vUv + vec2(0,h)).b;

					gl_FragColor = vec4(f1, f2, f3 ,1.);
				}

			}

		</script>
		<script id="fragmentStep2" type="x-shader/x-fragment">
			precision highp float;
			precision highp int;

			varying vec2 vUv;
			uniform float time;
			uniform float dt;
			uniform highp sampler2D tDiffuse3;

			void main() {

				if (time  == 0. )  {
					gl_FragColor = vec4(1./9.,1./9.,1./9.,1.);
				} else {
					float h = - dt;
					float f4 = texture2D( tDiffuse3, vUv + vec2(-h,h)).r;
					float f5 = texture2D( tDiffuse3, vUv + vec2(-h,0)).g;
					float f6 = texture2D( tDiffuse3, vUv + vec2(-h,-h)).b;

					gl_FragColor = vec4(f4, f5, f6 ,1.);
				}

			}

		</script>
		<script id="fragmentStep3" type="x-shader/x-fragment">
			precision highp float;
			precision highp int;

			varying vec2 vUv;
			uniform float time;
			uniform float dt;
			uniform highp sampler2D tDiffuse3;

			void main() {

				if (time  == 0. ) {
					gl_FragColor = vec4(1./9.,1./9.,1./9.,1.);
				} else {
					float h = - dt;
					float f7 = texture2D( tDiffuse3, vUv + vec2(0,-h)).r;
					float f8 = texture2D( tDiffuse3, vUv + vec2(h,-h)).g;
					float f9 = texture2D( tDiffuse3, vUv).b;

					gl_FragColor = vec4(f7, f8, f9 ,1.);
				}

			}

		</script>	
		<script id="fragmentInitMesh" type="x-shader/x-fragment">
			precision highp float;
			precision highp int;

			varying vec2 vUv;


			void main() {

				if ( vUv.x < 0.6 && vUv.x > 0.5 && vUv.y > 0.5 && vUv.y < 0.6 ) {

					gl_FragColor = vec4(1., 0., 0. ,1.);
				}

			}

		</script>
		<script id="fragmentBounceback1" type="x-shader/x-fragment">
			precision highp float;
			precision highp int;

			varying vec2 vUv;
			uniform highp sampler2D tDiffuse1;
			uniform highp sampler2D tDiffuse2;
			uniform highp sampler2D tDiffuse3;

			void main() {

				if ( vUv.x < 0.6 && vUv.x > 0.5 && vUv.y > 0.5 && vUv.y < 0.6 ) {
					vec4 v2 = texture2D(tDiffuse2,vUv );
					vec4 v3 = texture2D(tDiffuse3,vUv );
					//float f4 = v2.r;
					float f5 = v2.g;
					float f6 = v2.b;
					float f7 = v3.r;
					//float f8 = v3.g;
					//float f9 = v3.b;
					gl_FragColor = vec4(f5, f6, f7 ,1.);
				} else {
					gl_FragColor = texture2D(tDiffuse1,vUv );
				}

			}

		</script>
		<script id="fragmentBounceback2" type="x-shader/x-fragment">
			precision highp float;
			precision highp int;

			varying vec2 vUv;
			uniform highp sampler2D tDiffuse1;
			uniform highp sampler2D tDiffuse2;
			uniform highp sampler2D tDiffuse3;

			void main() {

				if ( vUv.x < 0.6 && vUv.x > 0.5 && vUv.y > 0.5 && vUv.y < 0.6 ) {
					vec4 v1 = texture2D(tDiffuse1,vUv );
					vec4 v3 = texture2D(tDiffuse3,vUv );
					//float f4 = v1.r;
					float f8 = v3.g;
					float f1 = v1.r;
					float f2 = v1.g;
					//float f8 = v3.g;
					//float f9 = v3.b;
					gl_FragColor = vec4(f8, f1, f2 ,1.);
				} else {
					gl_FragColor = texture2D(tDiffuse2,vUv );
				}

			}

		</script>	
		<script id="fragmentBounceback3" type="x-shader/x-fragment">
			precision highp float;
			precision highp int;

			varying vec2 vUv;
			uniform highp sampler2D tDiffuse1;
			uniform highp sampler2D tDiffuse2;
			uniform highp sampler2D tDiffuse3;

			void main() {

				if ( vUv.x < 0.6 && vUv.x > 0.5 && vUv.y > 0.5 && vUv.y < 0.6 ) {
					vec4 v1 = texture2D(tDiffuse1,vUv );
					vec4 v2 = texture2D(tDiffuse2,vUv );
					//float f1 = v1.r;
					//float f2 = v1.g;
					float f3 = v1.b;
					float f4 = v2.r;
					//float f5 = v2.g;
					//float f6 = v2.b;
					gl_FragColor = vec4(f3, f4, texture2D(tDiffuse3,vUv).b , 1.);
				} else {
					gl_FragColor = texture2D(tDiffuse3,vUv );
				}

			}

		</script>															
		<script id="vertexShader" type="x-shader/x-vertex">
			precision highp float;
			precision highp int;

			varying vec2 vUv;

			void main() {

				vUv = uv;
				gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

			}

		</script>

		<!-- JS code (non GLSL) is in separate .js file -->
		<script src="./js/lbm.js"> </script>

	</body>
</html>
